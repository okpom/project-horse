name: GDScript Format

on:
  push:
    branches: [main, master]
    paths:
      - "scripts/**/*.gd"
  pull_request:
    branches: [main, master]
    paths:
      - "scripts/**/*.gd"
  workflow_dispatch:

jobs:
  format:
    name: Format GDScript Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Download GDScript Formatter
        run: |
          FORMATTER_URL=$(curl -s https://api.github.com/repos/GDQuest/GDScript-formatter/releases/latest \
            | grep "browser_download_url.*linux-x86_64" \
            | cut -d '"' -f 4)

          echo "Downloading formatter from: $FORMATTER_URL"
          curl -L -o gdscript-formatter.zip "$FORMATTER_URL"
          unzip gdscript-formatter.zip
          chmod +x gdscript-formatter-*-linux-x86_64
          sudo mv gdscript-formatter-*-linux-x86_64 /usr/local/bin/gdscript-formatter

      - name: Format GDScript files
        run: |
          echo "Formatting GDScript files in scripts/ directory..."

          while IFS= read -r -d '' file; do
            echo "Formatting: $file"
            gdscript-formatter "$file"
          done < <(find scripts -name "*.gd" -type f -print0)

          echo "Formatting complete."

      - name: Commit formatted files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "style: auto-format GDScript files"
          file_pattern: "scripts/**/*.gd"
